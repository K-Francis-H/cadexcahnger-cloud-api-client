<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>CADExchanger Unofficial API Client</title>
		<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
		<link rel="stylesheet" href="style.css">
		<script>
			var fileContext;
			document.addEventListener("DOMContentLoaded", () => {
				const {ipcRenderer} = require("electron");
				const fs = require("fs");
				const AUTH = JSON.parse(fs.readFileSync("auth.json", "utf8"));
				//TODO if AUTH doesnot exist cant be loaded pop a dialog asking user to give us the creds
				const API = require("./auth_convert_dl.js")(AUTH);
				console.log(AUTH);
				console.log(API);

				//now load up user and files
				/*API.v1.ACCOUNT.GET.USERS_ME( (user) => {
					console.log(user);
					API.v1.DATA.GET.FILES(
				});*/
				/*API.meta.getUserInfo( (user) => {
					API.v1.DATA.GET.listFolders(user.user.rootFolder, (folders) => {
						//todo list folders
						console.log(folders);
						for(let i=0; i < folders.folders.length; i++){
							createFolderCard(folders.folders[i]);
						}
					});
				});
				API.v1.DATA.GET.FILES(null, (files) => {
					console.log(files);
					for(let i=0; i < files.files.length; i++){
						//TODO list the files as cards in the curent window
						createFileCard(files.files[i]);
					}
				});*/

				const BACK_STACK = [];
				const WORKING_DIR = ["Home"];
				refresh();

				document.getElementById("upload").addEventListener("click", () => {
					ipcRenderer.send('uploadFile');//TODO use second param to identify context and recieve it back!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! so we know which API call to use
					/*dialog.showOpenDialog({properties: ['openFile']})
						.then( result => {
							console.log(result);
							if(result.filePaths[0]){//at least one file selected, ignore others
								let file = {
									name: result.filePaths[0],
									data: fs.readFileSync(result.filePaths[0]) //Buffer
								}
								console.log(file);
								//event.sender.send("fileUploadData", file);
							}else{
								console.log("no file selected");
							}
						});
					*/
				});

				document.getElementById("back").addEventListener("click", () => {
					BACK_STACK.pop(); //remove current folder
					refresh(BACK_STACK.pop());
				});

				ipcRenderer.on('fileUploadData', (event, data) => {
					console.log(data);
					//TODO figure out context and upload file or wahtever
				});

				ipcRenderer.on('log', (event, data) => {
					console.log(data);
				});

				document.getElementById("context-download").addEventListener("click", (e) => {
					if(fileContext){
						console.log("download: "+fileContext.name);
						let fileName = fileContext.name;
						//ipcRenderer.send('download', fileContext.id);
						API.v1.DATA.GET.downloadFile(fileContext.id, (res) => {
							//ask dialog to save file somewhere
							//get buffer from the res then
							//ask the ipcMain to get a save location
							//or actually just pass this there and pop it
							//get body from res....
							//should be a buffer
							ipcRenderer.send('download', fileName, res);
						});
					}
				});
				document.getElementById("context-convert").addEventListener("click", (e) => {
					if(fileContext){
						console.log("convert: "+fileContext.name);
						ipcRenderer.send('store', fileContext.id, fileContext);
						location = "convert-remote.html?id="+fileContext.id;
						
					}
				});
				document.getElementById("context-properties").addEventListener("click", (e) => {
					if(fileContext){
						alert(JSON.stringify(fileContext, 4));
					}
				});
				document.getElementById("context-delete").addEventListener("click", (e) => {
					if(fileContext){
						console.log("delete: "+fileContext.name);
						//bring up dialog
						/*let choice = dialog.showMessageBoxSync({
							type: "question",
							buttons : ["Confirm", "Cancel"],
							title : "Delete File",
							message : "Do you really want to delete "+fileContext.name+"?"
						});
						alert(choice); */
						if(confirm("Do you really want to delete "+fileContext.name+"?") === true){
							console.log("confirm delete");
							API.v1.DATA.DELETE.FILES_ID(fileContext.id, (result) => {
								let folderId = BACK_STACK[BACK_STACK.length-1];
								refresh(folderId);
							});
						}
					}
				});

				function updateWorkingDirectory(){
					//TODO
				}

				function refresh(folder){
					BACK_STACK.push(folder);
					document.getElementById("card-section").innerHTML = "";
					API.meta.getUserInfo( (user) => {
						console.log(user);
						if(!folder){
							folder = user.rootFolder
						}
						API.v1.DATA.GET.listFolders(folder, (folders) => {
							//list folders
							console.log(folders);
							for(let i=0; i < folders.folders.length; i++){
								createFolderCard(folders.folders[i]);
							}
						});
						//TODO this way of passing seems crufty are there even other params?
						API.v1.DATA.GET.FILES({parentFolder: folder}, (files) => {
							console.log(files);
							for(let i=0; i < files.files.length; i++){
								//list the files as cards in the curent window
								createFileCard(files.files[i]);
							}
						});
					});
					
				}
			


				function createFileCard(file){
					let card = document.createElement("DIV");
					card.classList.add("card");
		
					//add viewer if file is public else use placeholder image
					if(file.public){
						let viewer = document.createElement("IFRAME");
						viewer.src = "https://cloud.cadexchanger.com/embedded.html?fileId="+file.id;
						viewer.width = "100%";
						card.appendChild(viewer);
					}else{
						//add a generic cube image
						let placeholder = document.createElement("IMG");
						placeholder.src = "cube_placeholder.png";
						placeholder.classList.add("card-img");
						card.appendChild(placeholder);
					}


					//place file name
					let container = document.createElement("DIV");
					container.classList.add("container");

					let title = document.createElement("H4");
					title.innerText = file.name;
					container.appendChild(title);

					let sizeLabel = document.createElement("H4");
					sizeLabel.innerText = prettySize(file.size);
					container.appendChild(sizeLabel);
				
					card.appendChild(container);

					//TODO attach onclicks/contextmenus for the file
					//add delete capability
					//add download capability
					//add convert
				
					card.onclick = function(event){
						//window.alert(file.id);
						//goto new page with more info
						//we do this by passing the file object to the main.js script
						//then retrieving it on the new page
					};
					//TODO switch to a ... options bar, or just have the onclick change the page to file only with options
					card.oncontextmenu = function(event){
						//set the clicked file context
						fileContext = file;

						event.preventDefault();
						if (document.getElementById( 
							"contextMenu").style.display == "block") 
							hideMenu(); 
						else { 
							var menu = document 
							    .getElementById("contextMenu") 
							      
							menu.style.display = 'block'; 
							menu.style.left = event.pageX + "px"; 
							menu.style.top = event.pageY + "px"; 
						} 
					};

					document.getElementById("card-section").appendChild(card);
				}

				function createFolderCard(folder){
					let card = document.createElement("DIV");
					card.classList.add("card");

					let img = document.createElement("IMG");
					img.src = "folder.svg";
					img.classList.add("card-img");
					card.appendChild(img);

					let container = document.createElement("DIV");
					container.classList.add("container");
					let title = document.createElement("H4");
					title.innerText = folder.name;
					container.appendChild(title);

					card.appendChild(container);

					//TODO onclicks
					card.onclick = function(){
						//navigate inside
						WORKING_DIR.push(folder.name);
						refresh(folder.id);
					}

					document.getElementById("card-section").appendChild(card);
				}

				function prettySize(bytes){
					let index = 0;
					let suffixes = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];					
					while(bytes > 1000){
						bytes = bytes/1000;
						index++;
					}
					return bytes.toFixed(2)+suffixes[index];
				}

				function hideMenu() { 
					document.getElementById("contextMenu").style.display = "none";
					fileContext = null;
				}

				document.onclick = hideMenu; 

				//DEBUG
				document.getElementById("view-convert-page").addEventListener("click", () => {
					location = "convert-remote.html";
				});
			});
		</script>
	</head>
	<body>
		<!--TODO determine way to send context to onclick for each event below-->
		<div id="contextMenu" class="context-menu" 
			style="display:none"> 
			<ul> 
				<li id="context-download"><a href="#">Download</a></li> 
				<li id="context-convert"><a href="#">Convert</a></li> 
				<li id="context-properties"><a href="#">Properties</a></li>
				<li id="context-delete"><a href="#">Delete</a></li> 
			</ul> 
		</div>
		<button id="back">Back</button> 
		<button id="upload">Upload</button>
		<button id="view-convert-page">View Convert Page</button>
		<div id="card-section"></div>
	</body>
</html>
