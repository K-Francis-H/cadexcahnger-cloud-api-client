<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Hello World!</title>
		<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
		<link rel="stylesheet" href="style.css">
		<script>
			var fileContext;
			document.addEventListener("DOMContentLoaded", () => {
				const {ipcRenderer, dialog} = require("electron");
				const fs = require("fs");
				const AUTH = JSON.parse(fs.readFileSync("auth.json", "utf8"));
				//TODO cannot load module....
				const API = require("./auth_convert_dl.js")(AUTH);
				console.log(AUTH);
				console.log(API);

				//now load up user and files
				/*API.v1.ACCOUNT.GET.USERS_ME( (user) => {
					console.log(user);
					API.v1.DATA.GET.FILES(
				});*/
				API.v1.DATA.GET.FILES(null, (files) => {
					console.log(files);
					for(let i=0; i < files.files.length; i++){
						//TODO list the files as cards in the curent window
						createFileCard(files.files[i]);
					}
				});

				document.getElementById("upload").addEventListener("click", () => {
					ipcRenderer.send('uploadFile');//TODO use second param to identify context and recieve it back!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! so we know which API call to use
					/*dialog.showOpenDialog({properties: ['openFile']})
						.then( result => {
							console.log(result);
							if(result.filePaths[0]){//at least one file selected, ignore others
								let file = {
									name: result.filePaths[0],
									data: fs.readFileSync(result.filePaths[0]) //Buffer
								}
								console.log(file);
								//event.sender.send("fileUploadData", file);
							}else{
								console.log("no file selected");
							}
						});
					*/
				});

				ipcRenderer.on('fileUploadData', (event, data) => {
					console.log(data);
					//TODO figure out context and upload file or wahtever
				});

				document.getElementById("context-download").addEventListener("click", (e) => {
					if(fileContext){
						console.log("download: "+fileContext.name);
					}
				});
				document.getElementById("context-convert").addEventListener("click", (e) => {
					if(fileContext){
						console.log("convert: "+fileContext.name);
					}
				});
				document.getElementById("context-properties").addEventListener("click", (e) => {
					if(fileContext){
						alert(JSON.stringify(fileContext, 4));
					}
				});
				document.getElementById("context-delete").addEventListener("click", (e) => {
					if(fileContext){
						console.log("delete: "+fileContext.name);
					}
				});
			});

			function createFileCard(file){
				let card = document.createElement("DIV");
				card.classList.add("card");
		
				//add viewer if file is public else use placeholder image
				if(file.public){
					let viewer = document.createElement("IFRAME");
					viewer.src = "https://cloud.cadexchanger.com/embedded.html?fileId="+file.id;
					viewer.width = "100%";
					card.appendChild(viewer);
				}else{
					//add a generic cube image
					let placeholder = document.createElement("IMG");
					placeholder.src = "cube_placeholder.png";
					placeholder.classList.add("card-img");
					card.appendChild(placeholder);
				}


				//place file name
				let container = document.createElement("DIV");
				container.classList.add("container");
				let title = document.createElement("H4");
				title.innerText = file.name;
				container.appendChild(title);
				
				card.appendChild(container);

				//TODO attach onclicks/contextmenus for the file
				//add delete capability
				//add download capability
				//add convert
				
				card.onclick = function(){
					window.alert(file.id);
				};
				card.oncontextmenu = function(event){
					//set the clicked file context
					fileContext = file;

					event.preventDefault();
					if (document.getElementById( 
						"contextMenu").style.display == "block") 
						hideMenu(); 
					else { 
						var menu = document 
						    .getElementById("contextMenu") 
						      
						menu.style.display = 'block'; 
						menu.style.left = event.pageX + "px"; 
						menu.style.top = event.pageY + "px"; 
					} 
				};

				document.body.appendChild(card);
			}

			function createFolderCard(folder){
				//TODO
			}

			function hideMenu() { 
				document.getElementById("contextMenu").style.display = "none";
				fileContext = null;
			}
			document.onclick = hideMenu; 
		</script>
	</head>
	<body>
		<!--TODO determine way to send context to onclick for each event below-->
		<div id="contextMenu" class="context-menu" 
			style="display:none"> 
			<ul> 
				<li id="context-download"><a href="#">Download</a></li> 
				<li id="context-convert"><a href="#">Convert</a></li> 
				<li id="context-properties"><a href="#">Properties</a></li>
				<li id="context-delete"><a href="#">Delete</a></li> 
			</ul> 
		</div> 
		<button id="upload">Upload</button>
	</body>
</html>
