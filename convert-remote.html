<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>CADExchanger Unofficial API Client</title>
		<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
		<link rel="stylesheet" href="style.css">
		<script>
			

			const EXPORT_FORMATS = {
				"IGES" : [".igs", ".iges"],
				"STEP" : [".stp", ".step"],
				"ACIS" : [".sat"],
				"ParaSolid" : [".x_t", ".x_b"],
				"JT" : [".jt"],
				"IFC" : [".ifc"],
				"Rhino" : [".3dm"],
				"BRep" : [".brep"],
				"Collada" : [".dae"],
				"DXF" : [".dxf"],
				"FBX" : [".fbx"],
				"glTF" : [".glb", ".gltf"],
				"OBJ" : [".obj"],
				"STL" : [".stl"],
				"VRML" : [".wrl"],
				"X3D" : [".x3d"],
				"Image" : [".png", ".jpg", ".jpeg", ".bmp"],
				"Archive" : [".zip"]
			};
			const IMPORT_FORMATS = {
				"SolidWorks" : [".sldasm", ".sldpart"],
				"Creo" : [".asm.*", ".prt.*"],
				"NX" : [".prt"],
				"IGES" : [".igs", ".iges"],
				"STEP" : [".stp", ".step"],
				"ACIS" : [".sat", ".sab"],
				"ParaSolid" : [".x_t", ".x_b", ".xmt_txt", ".xmt_bin", ".xmp_txt", ".xmp_bin"],
				"JT" : [".jt"],
				"IFC" : [".ifc"],
				"Rhino" : [".3dm"],
				"BRep" : [".brep"],
				"3DS" : [".3ds"],
				"3MF" : [".3mf"],
				"Collada" : [".dae"],
				"DXF" : [".dxf"],
				"FBX" : [".fbx"],
				"glTF" : [".glb", ".gltf"],
				"OBJ" : [".obj"],
				"STL" : [".stl"],
				"VRML" : [".wrl"],
				"Archive" : [".zip"]
			}
			const LENGTH_UNITS = [
				"mm",
				"cm",
				"m",
				"in",
				"ft",
				"yd",
				"Î¼m",
				"dm",
				"km",
				"mil",
				"mi"
			];
			const SPLIT_MODE = [
				"monolithic",
				"perPart",
				"perAssembly"
			];
			//TODO add tooltips based on descriptions from cadexchanger
			const PARAMS = {
				"IGES" : {
					"export" : {
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						},
						"writemode" : {
							"type" : "string",
							"options" : ["msbo", "boundedsurfaces"],
							"default" : "msbo",
							"tooltip" : "Specifies preferred type of topological entities. The following values are supported:\nboundedsurfaces - use Bounded Surface (type 143) when writing solid or sheet bodies.\nmsbo - use Manifold Solid B-Rep (type 186) when writing solid bodies and Bounded Surface (type 143) when writing sheet bodies."
						}
					}
				},
				"STEP" : {
					"import" : {
						"preferredBodyType" : {
							"type" : "string",
							"options" : ["auto", "all", "advancedBRep", "manifoldSurface", "nonManifoldSurface", "edgeBasedWireFrame"],
							"default" : "auto",
							"tooltip" : "Specifies the preferred B-Rep shape representation type, which should be imported. The following values are supported:\nauto - the most appropriate representation is chosen automatically.\nall - all representations are imported. This includes the main representation and all connected to it via relationships.\nadvancedBRep - prefer ADVANCED_BREP_SHAPE_REPRESENTATION, which stores solid bodies.\nmanifoldSurface - prefer MANIFOLD_SURFACE_SHAPE_REPRESENTATION, which stores sheet bodies with shells.\nnonManifoldSurface - prefer NON_MANIFOLD_SURFACE_SHAPE_REPRESENTATION, which stores sheet bodies with faces.\nedgeBasedWireframe - prefer EDGE_BASED_WIREFRAME_SHAPE_REPRESENTATION, which stores wireframe bodies.\nIn case the preferred representation cannot be found, the first appropriate is imported."
						}
					},
					"export" : {
						"split" : {
							"type" : "Split mode",
							"options" : SPLIT_MODE,
							"default" : SPLIT_MODE[0] //monolithic
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						},
						"savePCurves" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether p-curves (edge curves in 2D parametric space of face surfaces) should be written. Writing p-curves can be helpful for certain receiving CAD systems to import data from STEP files. However writing p-curves can increase an output file size considerably."
						}
					}
				},
				"ACIS" : {
					"export" : {
						"version" : {
							"type" : "number",
							"options" : [4, 7],
							"default" : 7
						}
					}
				},
				"JT" : {
					"export" : {
						"split" : {
							"type" : "Split mode",
							"options" : SPLIT_MODE,
							"default" : SPLIT_MODE[0] //monolithic
						},
						"saveBRep" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether part B-Rep representations should be saved."
						},
						"savePoly" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether polygonal representations should be saved."
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"IFC" : {
					"export" : {
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"Rhino" : {
					"import" : {
						"meshType" : {
							"type" : "string",
							"options" : ["default", "render", "analysis", "preview"],
							"default" : "default"
						},
						"readHidden" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether the hidden objects should be read."
						},
						"readPCurves" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether original parametric curves should be read from the file and impact on the reconstruction of BRep representation."
						}
					},
					"export" : {
						"version" : {
							"type" : "number",
							"options" : [2, 3, 4, 5, 6],
							"default" : 6
						},
						"saveBRep" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether part B-Rep representations should be saved."
						},
						"savePoly" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether polygonal representations should be saved."
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"FBX" : {
					"export" : {
						"version" : {
							"type" : "number",
							"options" : [2012, 2014, 2016, 2019],
							"default" : 2012
						},
						"text" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether generated file should be written in text form (true) or binary form (false)."
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"OBJ" : {
					"import" : {
						"grouping" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether forced grouping should be enabled to reduce amount of created parts."
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					},
					"export" : {
						"overrideDuplicateNames" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether original names should be supplemented by suffix(es) to provide unique name to every instance of the part. This allows to avoid merging of geometries of parts with same name during reading .obj file."
						},
						"saveNormals" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether vertex normal should be saved or not. When vertex normals are stored in the .obj file then the model can be displayed in smooth shading by third-party viewers. Otherwise the model will be displayed in flat shading only."
						},
						"generateMtl" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether material library should be generated or not. The material library contains materials used in the model. If the material library is not created then no colors or materials will be stored."
						},
						"replaceSpaces" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether space characters in part names should be replaced by '_' character or not. It can improve compatibility with receiving systems."
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"STL" : {
					"import" : {
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					},
					"export" : {
						"text" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether generated file should be written in text form (true) or binary form (false)."
						},
						"multipart" : {
							"type" : "boolean",
							"default" : true,
							"tooltip" : "Specifies whether each body is saved in a separate [solid/endsolid] section in STL file."
						},
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"VRML" : {
					"import" : {
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					},
					"export" : {
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						}
					}
				},
				"X3D" : {
					"export" : {
						"units" : {
							"type" : "Length Units",
							"options" : LENGTH_UNITS,
							"default" : LENGTH_UNITS[0] //mm
						},
						"saveNormals" : {
							"type" : "boolean",
							"default" : false,
							"tooltip" : "Specifies whether vertex normal should be saved or not. When vertex normals are stored in the file then the model can be displayed in smooth shading by third-party viewers. Otherwise the model will be displayed in flat shading only."
						}
					}
				},
				"Image" : {
					"export" : {
						"width" : {
							"type" : "number",
							"default" : 200
						},
						"height" : {
							"type" : "number",
							"default" : 200
						},
						"displayMode" : {
							"type" : "string",
							"options" : ["auto", "wireframe", "shaded", "shadedWithBoundaries"],
							"default" : "auto",
							"tooltip" : "Specifies display mode used for rendering. Should be one of auto, wireframe, shaded, shadedWithBoundaries. auto mode means to use shadedWithBoundaries for BRep representation and shaded otherwise." 
						},
						"representation" : {
							"type" : "string",
							"options" : ["auto", "brep", "poly", "finePoly", "mediumPoly", "coarsePoly"],
							"default" : "auto",
							"tooltip" : "Specifies representation used for export. Should be one of auto, brep,poly, finePoly, mediumPoly, coarsePoly. auto mode means to use BRep representation if available and Poly otherwise."
						},
						"cameraProjection" : {
							"type" : "string",
							"options" : ["isometric", "perspective"],
							"default" : "isometric"
						}
					}
				}
			};

			function createSelect(list){
				let select = document.createElement("SELECT");

				//TODO disabled hint option
				//let hintOPtion = document.createElement("

				for(let i=0; i < list.length; i++){
					let option = document.createElement("OPTION");
					option.innerText = list[i];
					option.value = list[i];
					select.appendChild(option);
				}
				return select;
			}

			function createToolTipContainer(tip){
				let container = document.createElement("DIV");
				container.classList.add("tooltip");

				let tipContainer = document.createElement("SPAN");
				tipContainer.classList.add("tooltiptext");
				tipContainer.innerText = tip;

				container.appendChild(tipContainer);
				return container;
			}

			function createAdditionalParams(root, params){
				//TODO copy from below
			}

			function setupConversionOptions(exportFormatSelect){
				//find the selected option and use it to update
				let selectedIndex = exportFormatSelect.selectedIndex;
				let key = exportFormatSelect.options[selectedIndex];
				//now update the extension list from this
				let extSelect = createSelect(EXPORT_FORMATS[key.value]);
				//TODO if length===1 just gray it out or maybe dont do anything
				document.getElementById("export-ext-select").innerHTML = "";
				document.getElementById("export-ext-select").appendChild(extSelect);

				//TODO setup other parameters (export)
				document.getElementById("additional-params").innerHTML = "";
				console.log(key);
				let exparams = PARAMS[key.value];
				if(exparams && exparams.export){
					//TODO add labels and tooltips
					let params = Object.keys(exparams.export);
					for(let i=0; i < params.length; i++){
						let p = exparams.export[params[i]];
						let el;
						console.log(p)

						if(p.type === "boolean"){
							let inp = document.createElement("INPUT");
							inp.type = "checkbox";
							inp.checked = p.default === true ? "checked" : "";
							inp.value = params[i]

							let label = document.createElement("LABEL");
							label.innerText = params[i];

							el = document.createElement("DIV");
							el.appendChild(inp);
							el.appendChild(label);
						}
						//else if(p.type === "string" && !p.options){
						//	el = document.createElement(
						//}
						else if(p.type === "number" && !p.options){
							let label = document.createElement("LABEL");
							label.innerText = params[i];
							//TODO add an element that is of type input number
							let inp = document.createElement("INPUT");
							inp.type = "number";
							inp.value=p.default;

							el = document.createElement("DIV");
							el.appendChild(label);
							el.appendChild(inp);
						}
						else if(p.options){
							let label = document.createElement("LABEL");
							label.innerText = params[i];

							let inp = createSelect(p.options);

							el = document.createElement("DIV");
							el.appendChild(label);
							el.appendChild(inp);
						}
						console.log(el);

						if(p.tooltip){
							let tip = createToolTipContainer(p.tooltip);
							tip.appendChild(el);
							document.getElementById("additional-params").appendChild(tip);
							//add line break because tooltip div is inline-block
							document.getElementById("additional-params").appendChild(document.createElement("BR"));
						}else{
							document.getElementById("additional-params").appendChild(el);
						}
					}
				}
			}

			document.addEventListener("DOMContentLoaded", () => {
				const {ipcRenderer} = require("electron");

				const exportFormatSelect = createSelect(Object.keys(EXPORT_FORMATS));
				//exportFormatSelect.id="export-format";
				exportFormatSelect.onchange = function(){
					setupConversionOptions(exportFormatSelect);
				};

				//TODO condense the above into functions

				//TODO require("the_api") and implement a conversion alg
				//keep checking til its done
				//when its done download
				
				//TODO add import options? 

				document.getElementById("export-format-select").appendChild(exportFormatSelect);
				exportFormatSelect.onchange();

				document.getElementById("back").addEventListener("click", () => {
					location="index.html";
				});

				//listen for ipcMains responses
				ipcRenderer.on('retrieve', (event, id, file) => {
					console.log(id);
					console.log(file);

					//TODO now setup the file div section
				});
				ipcRenderer.on('log', (event, data) => {
					console.log(data);
				});

				//load up the file
				let searchParams = new URLSearchParams(location.search);
				if(searchParams.has("id")){
					let id = searchParams.get("id");
					console.log(id);
					ipcRenderer.send('retrieveAndDestroy', id);
				}else{	
					//TODO error and return to main screen
				}

				
			});
			console.log(location);
		</script>
	</head>
	<body>
		<!--TODO determine way to send context to onclick for each event below-->
		<button id="back">Back</button> 
		</br></br></br></br></br></br></br></br></br></br></br></br></br></br></br></br>
		<div id="file-section">
			<!--TODO put file in here-->
		</div>
		<div id="card-section">
			<div>
				Format<span id="export-format-select"></span>
			</div>
			<div>
				File Extension<span id="export-ext-select"></span>
			</div>
			<div id="additional-params"></div>
		</div>
	</body>
</html>
